<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bank Transfer</title>

<!-- Tailwind, Vue, Lucide, Toastify -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />

<style>
:root { --base-color: #0069ff; }
.bg-base { background-color: var(--base-color); }
.text-base { color: var(--base-color); }
.border-base { border-color: var(--base-color); }

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fadeInUp { animation: fadeInUp 0.4s ease-out; }

@keyframes pulseOnce {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}
.animate-pulseOnce { animation: pulseOnce 0.6s ease-in-out; }

.bank-scroll {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  padding-bottom: 10px;
}
.bank-scroll::-webkit-scrollbar { display: none; }

.bank-item {
  flex: 0 0 auto;
  scroll-snap-align: start;
  width: 90px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}
.bank-item img {
  width: 50px;
  height: 50px;
  margin: auto;
  border-radius: 9999px;
  object-fit: contain;
  border: 2px solid transparent;
  transition: 0.3s;
}
.bank-item.selected img {
  border-color: var(--base-color);
  box-shadow: 0 0 0 3px var(--base-color);
}
.bank-item:hover { transform: translateY(-4px); }
.bank-item span {
  display: block;
  margin-top: 4px;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
</style>
</head>

<body class="bg-white h-screen flex flex-col font-sans">
<div id="app" class="flex flex-col h-full">

  <!-- Header -->
  <div class="flex items-center px-4 py-3 border-b">
    <button @click="goBack" class="p-2 rounded-full border border-gray-300">
      <i data-lucide="arrow-left" class="w-5 h-5"></i>
    </button>
    <h1 class="flex-1 text-center font-semibold text-lg">Bank Transfer</h1>
    <div class="w-8 h-8"></div>
  </div>

  <!-- Main Content -->
  <div class="flex-1 overflow-y-auto px-4 mt-4 space-y-4">

    <!-- Bank Search -->
    <input type="text" v-model="search" placeholder="Search bank..."
      class="w-full border rounded-lg px-3 py-3 outline-none transition focus:ring-2 focus:ring-base" />

    <!-- Scrollable Bank List -->
    <div class="bank-scroll mt-2">
      <div v-for="bank in filteredBanks" :key="bank.bankCode"
           :class="['bank-item', selectedBank && selectedBank.bankCode === bank.bankCode ? 'selected' : '']"
           @click="selectBank(bank)">
        <img :src="bank.logo_url || backupLogo" @error="onImageError($event)" />
        <span>{{ bank.bankName }}</span>
      </div>
    </div>

    <!-- Account Number -->
    <div class="border rounded-lg px-3 flex items-center">
      <input type="tel" placeholder="Account Number" maxlength="10" v-model="accountNumber"
             @input="handleAccountInput" class="flex-1 py-3 outline-none" />
      <svg v-if="verifying" class="animate-spin h-5 w-5 text-base" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
      </svg>
    </div>

    <!-- Account Name Display -->
    <transition name="fade">
      <div v-if="accountName"
        class="rounded-lg px-3 py-3 bg-green-50 text-green-700 font-semibold text-left animate-fadeInUp animate-pulseOnce shadow-sm">
        {{ accountName }}
      </div>
    </transition>

    <!-- Amount -->
    <div class="border rounded-lg px-3">
      <input type="number" placeholder="Amount (₦)" v-model="amount"
        class="flex-1 py-3 outline-none transition focus:ring-2 focus:ring-base" />
    </div>

  </div>

  <!-- Continue Button -->
  <div class="border-t bg-white p-4">
    <button @click="openPin" class="w-full py-3 bg-base text-white rounded-lg font-medium text-lg shadow-md hover:scale-[1.02] transition-transform">
      Continue
    </button>
  </div>

  <!-- PIN Modal -->
  <div v-if="showPin" class="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
    <div class="bg-white w-full h-3/4 rounded-t-2xl p-6 animate-fadeInUp flex flex-col relative">
      <button @click="showPin=false; pin=''" class="absolute top-4 right-4 p-2 rounded-full bg-gray-200">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
      <h2 class="text-lg font-semibold text-center mb-4">Enter 4-Digit PIN</h2>
      <div class="flex justify-center mb-6">
        <div class="text-3xl tracking-widest">{{ '•'.repeat(pin.length) }}</div>
      </div>
      <div class="grid grid-cols-3 gap-6 flex-1 place-items-center">
        <button v-for="n in 9" :key="n" @click="enterDigit(n)" class="w-16 h-16 flex items-center justify-center rounded-full border text-xl font-semibold">{{ n }}</button>
        <button @click="deleteDigit" class="w-16 h-16 flex items-center justify-center rounded-full border text-xl">⌫</button>
        <button @click="enterDigit(0)" class="w-16 h-16 flex items-center justify-center rounded-full border text-xl">0</button>
        <button @click="clearPin" class="w-16 h-16 flex items-center justify-center rounded-full border text-sm">Clear</button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div v-if="loading" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-[60]">
    <svg class="animate-spin h-12 w-12 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <p class="text-white text-lg font-medium animate-pulse">Processing...</p>
  </div>

</div>

<script>
const { createApp } = Vue;

createApp({
data() {
return {
  banks: [],
  search: '',
  selectedBank: null,
  accountNumber: '',
  accountName: '',
  verifying: false,
  amount: '',
  loading: false,
  showPin: false,
  pin: '',
  backupLogo: "https://firebasestorage.googleapis.com/v0/b/business-banking-93cc1.appspot.com/o/bankLogos%2FEmpty%20Bank%20Logo.png?alt=media&token=c800752e-e3f0-41cf-a4bc-de2d4017ca16"
};
},
computed: {
filteredBanks() {
  return this.banks.filter(b =>
    b.bankName.toLowerCase().includes(this.search.toLowerCase())
  );
}
},
async mounted() {
  lucide.createIcons();
  await this.checkKYC();
  this.getBanks();
},
methods: {
goBack() { window.location.href = '/app/dashboard'; },
onImageError(e) { e.target.src = this.backupLogo; },

async checkKYC() {
  try {
    const token = localStorage.getItem('token');
    const res = await fetch('https://pulsepoint.com.ng/api/kyc-status', {
      headers: { Authorization: `Bearer ${token}` },
    });
    const data = await res.json();
    if (!data.success || data.kyc_status !== 2) {
      this.toast('Please complete your KYC verification.', 'error');
      setTimeout(()=>window.location.href='/app/capture',1500);
    }
  } catch {
    this.toast('Unable to verify KYC status', 'error');
  }
},

async getBanks() {
  try {
    const res = await fetch('https://pulsepoint.com.ng/api/banklist');
    const data = await res.json();
    this.banks = data.data || data.body?.banks || [];
  } catch {
    this.toast('Network error loading banks', 'error');
  }
},

selectBank(bank) { this.selectedBank = bank; },

async handleAccountInput() {
  if (this.accountNumber.length === 10 && this.selectedBank) {
    this.verifying = true;
    try {
      const res = await fetch('https://pulsepoint.com.ng/api/verify-account', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bankCode: this.selectedBank.bankCode, accountNumber: this.accountNumber }),
      });
      const data = await res.json();
      const result = data.body || data;
      this.accountName = result.content?.accountName || '';
    } catch {
      this.toast('Network error verifying account', 'error');
    } finally {
      this.verifying = false;
    }
  }
},

openPin() {
  if (!this.selectedBank) return this.toast('Select a bank', 'error');
  if (!this.accountNumber || this.accountNumber.length < 10) return this.toast('Enter valid account number', 'error');
  if (!this.amount || this.amount <= 0) return this.toast('Enter valid amount', 'error');
  if (!this.accountName) return this.toast('Verify account first', 'error');
  this.showPin = true;
},

enterDigit(n) {
  if (this.pin.length < 4) {
    this.pin += n;
    if (this.pin.length === 4) {
      this.showPin = false;
      this.verifyPinAndTransfer();
    }
  }
},
deleteDigit() { this.pin = this.pin.slice(0, -1); },
clearPin() { this.pin = ''; },

async verifyPinAndTransfer() {
  this.loading = true;
  const token = localStorage.getItem('token');
  try {
    // 1️⃣ Verify PIN
    const pinRes = await fetch('https://your-domain.com/api/check-transaction-pin', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ pin: this.pin })
    });
    const pinData = await pinRes.json();

    if (!pinData.success) {
      this.loading = false;
      return this.toast('Invalid transaction PIN', 'error');
    }

    // 2️⃣ On success, send payout
    const payoutPayload = {
      amount: this.amount,
      clientRef: "BANK_" + Date.now(),
      accountNumber: this.accountNumber,
      bankCode: this.selectedBank.bankCode,
      bankName: this.selectedBank.bankName,
      narration: "Bank Transfer",
      accountReference: "REF_" + Math.random().toString(36).substring(2,10)
    };

    const payRes = await fetch('https://pulsepoint.com.ng/api/pay-out', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payoutPayload)
    });

    const payData = await payRes.json();
    const status = payData.status || payData.data?.status || 'error';
    const msg = payData.message || 'Transfer completed';

    const toastType = status === 'success' ? 'success' : (status === 'pending' ? 'warning' : 'error');
    this.toast(msg, toastType);

    if (status === 'success') {
      setTimeout(()=>window.location.href="/app/success.html", 1500);
    }

  } catch (e) {
    this.toast('Network error during transfer', 'error');
  } finally {
    this.loading = false;
    this.pin = '';
  }
},

toast(msg, type) {
  const bg = type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'red';
  Toastify({
    text: msg,
    duration: 3000,
    gravity: 'top',
    position: 'center',
    close: true,
    backgroundColor: bg
  }).showToast();
}
}
}).mount('#app');
</script>
</body>
</html>
